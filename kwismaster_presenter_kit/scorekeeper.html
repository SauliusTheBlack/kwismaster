<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Scorekeeper</title>
    <link rel="stylesheet" href="lib/scorekeeper/css/scorekeeper.css">

    <!--
        IMPORTANT: This scorekeeper uses the same quiz_data.js as the presenter
        It automatically reads rounds from the KWON data
    -->
    <script src="lib/presenter/js/quizDataLoader.js"></script>
    <script src="quiz_data.js"></script>
    <script src="lib/scorekeeper/js/networkSync.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Quiz Scorekeeper</h1>
            <div class="event-name" id="event-name"></div>
            <div class="connection-indicator" id="connection-indicator" style="display: none;">Not Connected</div>
        </header>

        <div class="card network-control">
            <h2>Network Sync</h2>
            <div class="network-buttons">
                <button class="btn-outline" onclick="showNetworkDialog()">‚ö° Setup Network Sync</button>
                <button class="btn-danger" onclick="clearNetworkMode()">Disconnect</button>
            </div>
            <div class="network-info">
                <p>Use Network Sync to connect the presenting laptop (Display) with the correction station (Entry).</p>
            </div>
        </div>

        <div class="card presentation-control">
            <h2>Score Presentation</h2>
            <div class="presentation-buttons">
                <button class="btn-primary" onclick="showPresentationConfig()">üì∫ Start Score Presentation</button>
            </div>
            <div class="presentation-info">
                <p>Display scores in a full-screen presentation that auto-advances through pages. No network connection required.</p>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs" id="tabs">
                <!-- Tabs will be generated by JavaScript -->
            </div>

            <div class="tab-contents" id="tab-contents">
                <!-- Tab content will be generated by JavaScript -->
            </div>
        </div>

        <div class="card team-management">
            <h2>Team Management</h2>
            <div class="form-group">
                <input type="text" id="new-team-name" placeholder="Enter team name" autocomplete="off">
                <button class="btn-secondary" onclick="addTeam()">Add Team</button>
                <button class="btn-quick-add" onclick="quickAddTeam()">+ Quick Add</button>
            </div>
        </div>

        <div class="card data-management">
            <h2>Data Management</h2>
            <div class="data-actions">
                <button class="btn-outline" onclick="exportScores()">üì§ Export Scores</button>
                <button class="btn-outline" onclick="importScores()">üì• Import Scores</button>
                <button class="btn-danger" onclick="resetAllScores()">Reset All Scores</button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
    </div>

    <!-- Network Setup Dialog -->
    <div id="network-dialog" class="modal">
        <div class="modal-content">
            <h2>Network Sync Setup</h2>
            <p>Choose your role:</p>
            <div class="network-mode-buttons">
                <button class="btn-primary" onclick="setNetworkMode('display')">
                    üì∫ Display Mode<br>
                    <small>(Presenting Laptop)</small>
                </button>
                <button class="btn-secondary" onclick="setNetworkMode('entry')">
                    ‚úèÔ∏è Entry Mode<br>
                    <small>(Correction Station)</small>
                </button>
            </div>
            <button class="btn-outline" onclick="hideNetworkDialog()">Cancel</button>
        </div>
    </div>

    <!-- Display Pairing File Dialog -->
    <div id="connection-code-dialog" class="modal">
        <div class="modal-content">
            <h2>üì∫ Display Mode - Step 1 of 2</h2>
            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-lg);">Download the pairing file and transfer it to the <strong>Entry Station</strong> laptop using a USB stick.</p>

            <div style="background-color: #fef3c7; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); border: 2px solid #f59e0b;">
                <p style="margin-bottom: 0; color: #92400e; font-weight: 600;">‚ö†Ô∏è IMPORTANT: Do not refresh this page during pairing! Refreshing will cancel the connection process.</p>
            </div>

            <div style="background-color: var(--color-bg); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                <p style="margin-bottom: var(--spacing-sm);"><strong>Instructions:</strong></p>
                <ol style="margin-left: var(--spacing-lg); line-height: 1.8;">
                    <li>Click "Download Pairing File" below</li>
                    <li>Copy the <code>scorekeeper.pair</code> file to a USB stick</li>
                    <li>Plug the USB stick into the Entry Station laptop</li>
                    <li>On the Entry Station, upload the <code>scorekeeper.pair</code> file</li>
                </ol>
            </div>

            <button class="btn-primary" onclick="downloadPairFile()" style="font-size: 1.1rem; padding: var(--spacing-md) var(--spacing-xl);">‚¨áÔ∏è Download Pairing File</button>
            <hr>
            <p style="margin-top: var(--spacing-lg);">After the Entry Station processes your file, you'll receive a <code>scorekeeper.pair2</code> file. Upload it below:</p>
            <input type="file" id="pair2-upload" accept=".pair2" style="display: none;" onchange="handlePair2Upload(event)">
            <button class="btn-secondary" onclick="document.getElementById('pair2-upload').click()">‚¨ÜÔ∏è Upload Response File (.pair2)</button>
            <button class="btn-outline" onclick="closeAllDialogs()">Cancel</button>
        </div>
    </div>

    <!-- Entry Pairing File Dialog -->
    <div id="entry-code-dialog" class="modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Entry Mode - Step 1 of 2</h2>
            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-lg);">Upload the pairing file from the <strong>Display Station</strong> laptop.</p>

            <div style="background-color: #fef3c7; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); border: 2px solid #f59e0b;">
                <p style="margin-bottom: 0; color: #92400e; font-weight: 600;">‚ö†Ô∏è IMPORTANT: Do not refresh this page during pairing! Refreshing will cancel the connection process.</p>
            </div>

            <div style="background-color: var(--color-bg); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                <p style="margin-bottom: var(--spacing-sm);"><strong>Instructions:</strong></p>
                <ol style="margin-left: var(--spacing-lg); line-height: 1.8;">
                    <li>Insert the USB stick from the Display Station</li>
                    <li>Click "Upload Pairing File" below</li>
                    <li>Select the <code>scorekeeper.pair</code> file from the USB stick</li>
                    <li>Download the response file that appears</li>
                    <li>Transfer the <code>scorekeeper.pair2</code> file back to the Display Station</li>
                </ol>
            </div>

            <input type="file" id="pair-upload" accept=".pair" style="display: none;" onchange="handlePairUpload(event)">
            <button class="btn-primary" onclick="document.getElementById('pair-upload').click()" style="font-size: 1.1rem; padding: var(--spacing-md) var(--spacing-xl);">‚¨ÜÔ∏è Upload Pairing File (.pair)</button>
            <button class="btn-outline" onclick="closeAllDialogs()">Cancel</button>
        </div>
    </div>

    <!-- Entry Response File Dialog -->
    <div id="answer-code-dialog" class="modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Entry Mode - Step 2 of 2</h2>
            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-lg);">Download the response file and transfer it back to the <strong>Display Station</strong> laptop.</p>

            <div style="background-color: #d1fae5; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); border: 2px solid #10b981;">
                <p style="margin-bottom: var(--spacing-sm); color: #065f46;"><strong>‚úì Pairing file processed successfully!</strong></p>
            </div>

            <div style="background-color: #fef3c7; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); border: 2px solid #f59e0b;">
                <p style="margin-bottom: 0; color: #92400e; font-weight: 600;">‚ö†Ô∏è IMPORTANT: Do not refresh this page! Keep it open until the Display Station completes the pairing.</p>
            </div>

            <div style="background-color: var(--color-bg); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                <p style="margin-bottom: var(--spacing-sm);"><strong>Next steps:</strong></p>
                <ol style="margin-left: var(--spacing-lg); line-height: 1.8;">
                    <li>Click "Download Response File" below</li>
                    <li>Copy the <code>scorekeeper.pair2</code> file to the USB stick</li>
                    <li>Plug the USB stick into the Display Station laptop</li>
                    <li>On the Display Station, upload the <code>scorekeeper.pair2</code> file</li>
                </ol>
            </div>

            <button class="btn-primary" onclick="downloadPair2File()" style="font-size: 1.1rem; padding: var(--spacing-md) var(--spacing-xl);">‚¨áÔ∏è Download Response File</button>
            <p style="margin-top: var(--spacing-lg);"><small>After the Display Station uploads this file, the connection will be established!</small></p>
            <button class="btn-outline" onclick="closeAllDialogs()">Close</button>
        </div>
    </div>

    <!-- Presentation Configuration Dialog -->
    <div id="presentation-config-dialog" class="modal">
        <div class="modal-content">
            <h2>üì∫ Display Presentation Setup</h2>
            <p style="margin-bottom: var(--spacing-lg);">Configure the score presentation for display.</p>

            <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                <label style="display: block; font-weight: 600; margin-bottom: var(--spacing-sm);">Select Rounds to Display:</label>
                <div id="round-selector-list" style="display: flex; flex-direction: column; gap: var(--spacing-sm); max-height: 300px; overflow-y: auto; padding: var(--spacing-md); background: var(--color-bg); border-radius: var(--radius-md);">
                    <!-- Round checkboxes will be inserted here -->
                </div>
            </div>

            <div class="form-group" style="margin-bottom: var(--spacing-xl);">
                <label for="presentation-timer" style="display: block; font-weight: 600; margin-bottom: var(--spacing-sm);">Timer Duration (seconds per page):</label>
                <input type="number" id="presentation-timer" value="30" min="5" max="300" style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;">
            </div>

            <div style="display: flex; gap: var(--spacing-md);">
                <button class="btn-primary" onclick="startPresentation()" style="flex: 1;">Start Presentation</button>
                <button class="btn-outline" onclick="closePresentationConfig()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Presentation View (Full Screen) -->
    <div id="presentation-view" style="display: none;">
        <div id="presentation-header" style="position: fixed; top: 0; left: 0; right: 0; background: var(--color-surface); padding: var(--spacing-md); box-shadow: var(--shadow-md); z-index: 100; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 1.25rem; font-weight: 600;" id="presentation-event-name"></div>
            <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                <div id="presentation-timer-display" style="font-size: 1.1rem; font-weight: 500; color: var(--color-text-secondary);"></div>
                <div id="presentation-page-indicator" style="font-size: 1rem; color: var(--color-text-secondary);"></div>
                <button class="btn-outline" onclick="stopPresentation()" style="padding: var(--spacing-sm) var(--spacing-lg);">Stop Presentation</button>
            </div>
        </div>
        <div id="presentation-content" style="margin-top: 70px; padding: var(--spacing-xl);">
            <!-- Presentation pages will be inserted here -->
        </div>
    </div>

    <script src="lib/scorekeeper/js/scorekeeper.js"></script>
</body>
</html>
